import { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, serverTimestamp, getDocs } from 'firebase/firestore';

const AbsenceSystemApp = () => {
  const [app, setApp] = useState(null);
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  const [userName, setUserName] = useState('');
  const [absenceDate, setAbsenceDate] = useState('');
  const [proofLink, setProofLink] = useState('');
  const [totalValue, setTotalValue] = useState(0);
  const [absenceHistory, setAbsenceHistory] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [errorMessage, setErrorMessage] = useState('');

  // Prepara o Firebase
  useEffect(() => {
    try {
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
      
      const firebaseApp = initializeApp(firebaseConfig, 'absence-system-' + appId);
      const authInstance = getAuth(firebaseApp);
      const dbInstance = getFirestore(firebaseApp);

      setApp(firebaseApp);
      setAuth(authInstance);
      setDb(dbInstance);

      const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
        if (user) {
          setUserId(user.uid);
          setIsAuthReady(true);
        } else {
          try {
            if (typeof __initial_auth_token !== 'undefined') {
              await signInWithCustomToken(authInstance, __initial_auth_token);
            } else {
              await signInAnonymously(authInstance);
            }
          } catch (error) {
            console.error("Erro ao autenticar:", error);
            setIsAuthReady(true);
          }
        }
      });

      return () => unsubscribe();
    } catch (e) {
      console.error("Erro na inicialização do Firebase:", e);
      setErrorMessage("Erro ao iniciar a aplicação. Verifique a configuração.");
    }
  }, []);

  // Monitora a coleção de dados do Firestore
  useEffect(() => {
    if (!isAuthReady || !db || !userId) {
      return;
    }

    const collectionPath = `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/absences`;
    const absencesRef = collection(db, collectionPath);
    const q = query(absencesRef);

    const unsubscribe = onSnapshot(q, (snapshot) => {
      let currentTotal = 0;
      const newHistory = [];
      snapshot.forEach((doc) => {
        const data = doc.data();
        const value = data.value || 0;
        currentTotal += value;
        newHistory.push({
          id: doc.id,
          ...data,
        });
      });
      setTotalValue(currentTotal);
      setAbsenceHistory(newHistory.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()));
      setIsLoading(false);
    }, (error) => {
      console.error("Erro ao buscar dados:", error);
      setErrorMessage("Erro ao carregar os dados. Tente novamente.");
      setIsLoading(false);
    });

    return () => unsubscribe();
  }, [isAuthReady, db, userId]);

  const handleAddAbsence = async (e) => {
    e.preventDefault();
    setErrorMessage('');

    if (!userName || !absenceDate || !proofLink) {
      setErrorMessage("Por favor, preencha todos os campos obrigatórios.");
      return;
    }

    if (!db || !userId) {
      setErrorMessage("Erro no banco de dados. Tente recarregar a página.");
      return;
    }

    try {
      const newAbsence = {
        name: userName,
        date: absenceDate,
        value: 10, // Valor fixo de R$ 10,00 como no botão da imagem
        proofLink: proofLink,
        createdAt: serverTimestamp(),
      };

      const collectionPath = `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/absences`;
      await addDoc(collection(db, collectionPath), newAbsence);

      // Limpa o formulário
      setUserName('');
      setAbsenceDate('');
      setProofLink('');
    } catch (error) {
      console.error("Erro ao registrar a falta:", error);
      setErrorMessage("Erro ao registrar a falta. Verifique sua conexão.");
    }
  };

  const today = new Date().toISOString().split('T')[0];

  return (
    <div className="bg-gray-100 min-h-screen p-4 sm:p-8 flex flex-col items-center">
      <div className="w-full max-w-3xl">

        {/* Cabeçalho */}
        <header className="text-center mb-8">
          <h1 className="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">
            Sistema de Registro de Faltas
          </h1>
          <p className="text-sm text-gray-500">Seu ID de Usuário: {userId ? userId : 'Carregando...'}</p>
        </header>

        {/* Mensagem de Atenção */}
        <div className="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 rounded-lg shadow mb-6" role="alert">
          <p className="font-semibold">Atenção:</p>
          <p className="text-sm">Os valores acumulados serão utilizados para a compra de itens de consumo e melhorias voltadas aos treinos da academia.</p>
        </div>

        {/* Box de Registro de Nova Falta */}
        <div className="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-6">
          <h2 className="text-xl sm:text-2xl font-bold text-indigo-700 text-center mb-6">Registrar Nova Falta</h2>
          
          {errorMessage && (
            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded mb-4" role="alert">
              <p>{errorMessage}</p>
            </div>
          )}

          <form onSubmit={handleAddAbsence} className="space-y-4">
            <div className="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
              <div className="flex-1">
                <label htmlFor="name" className="block text-gray-700 text-sm font-medium mb-1">Nome:</label>
                <input 
                  type="text" 
                  id="name" 
                  value={userName} 
                  onChange={(e) => setUserName(e.target.value)} 
                  placeholder="Digite o nome" 
                  className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div className="flex-1">
                <label htmlFor="date" className="block text-gray-700 text-sm font-medium mb-1">Data da Falta:</label>
                <input 
                  type="date" 
                  id="date" 
                  value={absenceDate} 
                  onChange={(e) => setAbsenceDate(e.target.value)} 
                  max={today}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
            </div>

            <div>
              <label htmlFor="proofLink" className="block text-gray-700 text-sm font-medium mb-1">Link do Comprovante (Obrigatório):</label>
              <input 
                type="text" 
                id="proofLink" 
                value={proofLink} 
                onChange={(e) => setProofLink(e.target.value)} 
                placeholder="Cole o link do comprovante (ex: foto no Google Drive)" 
                className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
            </div>
            
            <button 
              type="submit" 
              className="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300"
            >
              Registrar Falta (R$ 10,00)
            </button>
          </form>
        </div>

        {/* Box de Total em Caixa */}
        <div className="bg-green-100 p-6 sm:p-8 rounded-xl shadow-lg mb-6 text-center">
          <h2 className="text-2xl font-bold text-green-700 mb-2">Total em Caixa:</h2>
          <p className="text-4xl sm:text-5xl font-bold text-green-800">
            R$ {totalValue.toFixed(2).replace('.', ',')}
          </p>
        </div>

        {/* Histórico de Faltas */}
        <div className="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
          <h2 className="text-2xl font-bold text-gray-700 text-center mb-6">Histórico de Faltas</h2>
          
          {isLoading ? (
            <div className="text-center text-gray-500">Carregando histórico...</div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full table-auto">
                <thead>
                  <tr className="bg-gray-50 text-gray-600 text-left uppercase text-sm leading-normal">
                    <th className="py-3 px-6 text-left">NOME</th>
                    <th className="py-3 px-6 text-left">DATA DA FALTA</th>
                    <th className="py-3 px-6 text-left">VALOR</th>
                    <th className="py-3 px-6 text-left">COMPROVANTE</th>
                  </tr>
                </thead>
                <tbody className="text-gray-600 text-sm font-light">
                  {absenceHistory.length > 0 ? (
                    absenceHistory.map((item, index) => (
                      <tr key={index} className="border-b border-gray-200 hover:bg-gray-100">
                        <td className="py-3 px-6">{item.name}</td>
                        <td className="py-3 px-6">
                          {new Date(item.date).toLocaleDateString('pt-BR')}
                        </td>
                        <td className="py-3 px-6 text-red-500 font-semibold">
                          -R$ {item.value.toFixed(2).replace('.', ',')}
                        </td>
                        <td className="py-3 px-6">
                          <a href={item.proofLink} target="_blank" rel="noopener noreferrer" className="text-indigo-500 hover:underline">
                            Ver
                          </a>
                        </td>
                      </tr>
                    ))
                  ) : (
                    <tr>
                      <td colSpan="4" className="py-6 text-center text-gray-500">Nenhuma falta registrada ainda.</td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          )}
        </div>

      </div>
    </div>
  );
};

export default AbsenceSystemApp;
